<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="sp-player.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="sharedicons.html">
<link rel="import" href="notifier.html">

<script src="../bower_components/file-saver/FileSaver.min.js"></script>

<iron-iconset-svg size="24" name="console">
<svg><defs>
<g id="clear"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></g>
<g id="download"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></g>
<g id="edit"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></g>
<g id="loop"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"></path></g>
<g id="crossfade"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"></path></g>
<g id="multi"><path d="M19 9H2v2h17V9zm0-4H2v2h17V5zM2 15h13v-2H2v2zm15-2v6l5-3-5-3z"></path></g>
<g id="stop"><path d="M6 6h12v12H6z"></path></g>
</defs></svg>
</iron-iconset-svg>

<dom-module id="sp-console">
  <template>
    <style include="shared-styles">
    
      @media (max-width: 480px) {
        
        #btnsRow, #actionsRow {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
        }
        
        #actionsRow {
          padding-bottom: 10px;
        }
        
        #actionsRow > paper-button {
          width: 45%;
        }
        
        #audioBtns sp-player {
          width: 47.5%;
        }
        
      }
      
      @media (min-width: 481px) {
        
        #headerPlaceholder, #btnsRow {
          border-bottom: 1px solid rgba(0, 0, 0, 0.12);
        }
        
        #btnsRow, #actionsRow {
          padding: 10px 0;
        }
        
        #actionsRow > paper-button, #audioBtns sp-player {
          width: 160px;
        }
        
      }
    
      @keyframes slide-out {
        0% {
          opacity: 1;
          transform: none;
        }
        70% {
          opacity: 0;
        }
        100% {
          opacity: 0;
          transform: translateX(100%);
        }
      }
      
      @keyframes slide-in {
        0% {
          opacity: 0;
          transform: translateX(100%);
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 1;
          transform: none;
        }
      }
      
      paper-button {
        font-weight: 500 !important;
      }
      
      paper-button > iron-icon {
        margin-right: 4px;
      }
      
      paper-button:not([active]) > iron-icon {
        color: #009688;
        opacity: 1;
      }
      
      paper-button[dialog-confirm] {
        color: #f44336;
      }
      
      #headerPlaceholder > img {
        width: 40px;
        height: 40px;
        margin-left: 24px;
      }
      
      #btnsRow, #actionsRow {
        padding: 4px 0;
      }
      
      #btnsRow, #actionsRow paper-button {
        color: rgba(0, 0, 0, 0.7);
      }
      
      #btnsRow > paper-button {
        background: none;
        transition: background 160ms;
      }
      
      #btnsRow > paper-button:not(#clearBtn):focus {
        background: #b2dfdb;
      }
      
      #clearBtn:focus {
        background: #ef9a9a;
      }
      
      #actionsRow {
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
        position: sticky;
        top: -1px;
        background-color: #e0e0e0;
      }
      
      #actionsRow > paper-button {
        background-color: white;
        margin: 4px;
      }
      
      #actionsRow > paper-button[active] {
        background-color: #009688;
        color: white;
      }
      
      #audioBtns h3 {
        font-family: 'Montserrat', sans-serif;
        font-size: 14px;
        color: black;
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
      }
      
      #audioBtns h3 {
        width: 100%;
        margin: 8px;
      }
      
      #audioBtns .card {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: start;
        /*width: calc(100% - 16px);*/
      }
      
      #audioBtns sp-player {
        margin: 4px;
      }

    </style>
    
    <div id="headerPlaceholder">
      <img alt="Very cool icon" src="images/icons/192.png">
      <h2 class="header">Specta Player</h2>
    </div>
    
    <div id="btnsRow">
      <paper-button id="editBtn" on-tap="_sendCloseEvent">
        <iron-icon icon="console:edit"></iron-icon>
        Edit
      </paper-button>
      <paper-button id="downloadBtn" on-tap="_downloadConfig">
        <iron-icon icon="console:download"></iron-icon>
        Download
      </paper-button>
      <paper-button id="clearBtn" on-tap="_clearData">
        <iron-icon icon="console:clear"></iron-icon>
        Clear all
      </paper-button>
    </div>
      
    <div id="actionsRow">
      <paper-button id="stopBtn" raised on-tap="_stopAllTracks">
        <iron-icon icon="console:stop"></iron-icon>
        Stop all
      </paper-button>
      
      <paper-button id="loopBtn" toggles raised on-active-changed="_toggleLoop">
        <iron-icon icon="console:loop"></iron-icon>
        Loop
      </paper-button>
      
      <paper-button id="crossfadeBtn" toggles raised on-active-changed="_toggleCrossfade">
        <iron-icon icon="console:crossfade"></iron-icon>
        Crossfade
      </paper-button>
      
      <paper-button id="multiBtn" toggles raised active="{{multi}}" on-active-changed="_multiSwitched">
        <iron-icon icon="console:multi"></iron-icon>
        Simultanous
      </paper-button>
    </div>
    
    <div id="audioBtns"></div>
  </template>

  <script>
    class PlayerConsole extends Polymer.Element {
      
      static get is() { return 'sp-console'; }
      
      static get properties() { return {
        
        data: {
          type: Array,
          notify: true,
          observer: '_renderElements'
        },
        
        multi: Boolean,
        
        crossfade: Boolean
        
      } }
      
      constructor() {
        super();
      }
      
      connectedCallback() {
        super.connectedCallback();
        
        this._playingTracks = this._playingTracks || [];
        
        this.addEventListener('audioplayed', e => {
          const i = e.detail;
          if (!this.multi) this._stopAllTracks();
          this._playingTracks.push(i);
        });
        
        this.addEventListener('audiopaused', e => {
          const i = e.detail;
          this._playingTracks.splice(this._playingTracks.indexOf(i), 1);
        });
      }
      
      close() {
        this.classList.add('closing');
        setTimeout(() => { this.classList.remove('closing'); this.classList.add('hidden'); }, 360);
      }
      
      _sendCloseEvent() {
        window.dispatchEvent(new CustomEvent('openspupload'));
      }
      
      open() {
        if (this.classList.contains('first-open')) {
          this.classList.remove('first-open');
          this.classList.remove('hidden');
        } else {
          this.classList.add('opening');
          this.classList.remove('hidden');
          setTimeout(() => this.classList.remove('opening'), 360);
        }
      }
      
      _renderElements(data) {
        let htmlString = '<div class="card">';
        data.forEach((item, index) => {
          if (item.type === 'label') {
            if (htmlString.match(/<div class="card">$/)) {
              htmlString = htmlString.slice(0, -18);
              htmlString += `<h3>${item.name}</h3> <div class="card">`;
            } else
              htmlString += `</div> <h3>${item.name}</h3> <div class="card">`;
          } else if (item.type === 'audio') {
            htmlString += `<sp-player song="${item.song}" index="${index}">${item.name}</sp-player>`;
          }
        });
        if (htmlString.match(/<div class="card">$/)) {
          htmlString = htmlString.slice(0, -18);
        } else 
          htmlString += '</div>'
        this.$.audioBtns.insertAdjacentHTML('beforeend', htmlString);
      }
      
      _stopAllTracks() {
        this._playingTracks.forEach(i => {
          this.shadowRoot.querySelector(`sp-player[index="${i}"]`).$.btn.click();
        });
      }
      
      _multiSwitched(e) {
        const state = e.target.active;
        if (!state && this._playingTracks) {
          const temp = this._playingTracks.pop();
          this._stopAllTracks();
          this._playingTracks.push(temp);
        }
      }
      
      _toggleLoop(e) {
        const state = e.detail.value;
        Array.from(this.shadowRoot.querySelectorAll('sp-player')).forEach(item => {
          item.loop = state;
        });
      }
      
      _toggleCrossfade(e) {
        const state = e.detail.value;
        Array.from(this.shadowRoot.querySelectorAll('sp-player')).forEach(item => {
          item.crossfade = state;
        });
      }
      
      _clearData() {
        Notifier.askDialog('Remove everything?', {
          innerMsg: 'Delete app data and start over?\n(This won\'t remove files from your device)',
          cancelText: 'Keep it',
          acceptText: 'Remove',
          target: this.shadowRoot
        }).then(() => {
          this.dispatchEvent(new CustomEvent('cleardatabase', { bubbles: true, composed: true }));
        }).catch(e => {
          if (e.error && !e.canceledDialog) throw e.error;
        });
      }
      
      _downloadConfig() {
        const data = {
          type: 'SpectaPlayerConfigJSON-rev1',
          order: this.data,
          audio: window._audio
        };
        const file = new File([JSON.stringify(data)], 'specta-player-config.json', { type: "application/json;charset=utf-8" });
        saveAs(file);
      }
      
    }

    customElements.define(PlayerConsole.is, PlayerConsole);
  </script>
</dom-module>
