<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="sp-player.html">
<link rel="import" href="shared-styles.html">

<script src="../bower_components/file-saver/FileSaver.min.js"></script>

<iron-iconset-svg size="24" name="console">
<svg><defs>
<g id="clear"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></g>
<g id="download"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></g>
<g id="edit"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></g>
<g id="loop"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"></path></g>
<g id="crossfade"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"></path></g>
<g id="multi"><path d="M19 9H2v2h17V9zm0-4H2v2h17V5zM2 15h13v-2H2v2zm15-2v6l5-3-5-3z"></path></g>
<g id="stop"><path d="M6 6h12v12H6z"></path></g>
</defs></svg>
</iron-iconset-svg>

<dom-module id="sp-console">
  <template>
    <style include="shared-styles">

      @keyframes slide-out {
        
        0% {
          opacity: 1;
          transform: none;
        }
        
        70% {
          opacity: 0;
        }
        
        100% {
          opacity: 0;
          transform: translateX(100%);
        }
        
      }
      
      @keyframes slide-in {
        
        0% {
          opacity: 0;
          transform: translateX(100%);
        }
        
        70% {
          opacity: 1;
        }
        
        100% {
          opacity: 1;
          transform: none;
        }
        
      }

      @keyframes slide-out-to-bottom {
        
        0% {
          transform: none;
        }
        
        100% {
          transform: translateY(100%);
        }
        
      }
      
      @keyframes slide-in-from-bottom {
        
        0% {
          transform: translateY(100%);
        }
        
        100% {
          transform: none;
        }
        
      }

      :host(.closing) {
        animation: 360ms ease-in-out slide-out;
      }
      :host(.closing) #actions-row {
        animation: 360ms ease-in slide-out-to-bottom;
      }

      :host(.opening) {
        animation: 360ms ease-in-out slide-in;
      }
      :host(.opening) #actions-row {
        animation: 360ms ease-out slide-in-from-bottom;
      }
    
      .toolbar > img {
        width: 40px;
        height: 40px;
        margin-right: 16px;
      }
      
      #buttons-row {
        padding-left: 13px;
      }
      #buttons-row > paper-button {
        padding: 0 10px 0 8px;
        height: 36px;
        margin: 0 3px;
        color: var(--secondary-text-color);
      }
      #buttons-row > paper-button > iron-icon {
        height: 24px;
        width: 24px;
        margin-right: 5px;
        color: var(--primary-color);
      }
      #clear-btn {
        --paper-button-ink-color: #f44336 !important;
      }
      
      #actions-row {
        z-index: 2;
        position: fixed;
        bottom: 0;
        display: flex;
      }
      #actions-row > paper-button {
        color: var(--primary-text-color);
        --paper-button-ink-color: var(--primary-color);
      }

      @media (orientation: landscape) and (max-width: 600px),
       (orientation: portrait) and (max-width: 960px) {
        
        #actions-row {
          left: 0;
          right: 0;
          height: 70px;
          padding: 0 5vw;
          align-items: stretch;
          justify-content: stretch;
          background-color: var(--white-color);
          box-shadow:
            0 10px 8px rgba(0,0,0,0.14),
            0 -3px 14px rgba(0,0,0,0.12),
            0 -4px 15px rgba(0,0,0,0.2);
        }
        #actions-row > paper-button {
          flex: 1;
          min-width: unset;
          min-height: unset;
          flex-direction: column;
          text-transform: none;
          font-weight: 400 !important;
          padding: 0;
          margin: 0;
          font-size: 14px;
          border-radius: 0;
        }
        #actions-row > paper-button > iron-icon {
          width: 24px;
          height: 24px;
          margin-bottom: 6px;
        }
        #actions-row > paper-button[active] {
          color: var(--primary-color);
        }
       
      }
      
      #audio-container {
        margin-bottom: 80px;
        box-shadow:
          0 3px 4px rgba(0,0,0,0.1),
          0 1px 5px rgba(0,0,0,0.1);
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-gap: 1px;
        background: #f4f4f4;
      }
      
      #audio-container > h2 {
        grid-column: 1 / -1;
        font-size: 14px;
        font-family: var(--header-font);
        font-weight: 600;
        padding: 0 16px;
        margin: 0;
        height: 48px;
        line-height: 48px;
        background-color: #EEEEEE;
        color: var(--primary-text-color);
      }
      
      @media (min-width: 480px) {
      
        #audio-container {
          grid-template-columns: repeat(4, 1fr);
        }
      
      }
      
      @media (orientation: portrait) and (min-width: 840px),
       (orientation: landscape) and (min-width: 960px) {
      
        #audio-container {
          grid-template-columns: repeat(6, 1fr);
        }
      
      }

      sp-player {
        background-color: #FFFFFF;
      }
      
      sp-player::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        opacity: 0;
        transition: opacity 160ms ease-in-out;
        box-shadow:
          0 3px  5px rgba(0,0,0,0.14),
          0 1px 18px rgba(0,0,0,0.2);
      }
      sp-player[active]::after {
        opacity: 1 !important;
      }
      sp-player[pressed]::after {
        opacity: 0.3;
      }
      sp-player[active], sp-player[pressed] {
        z-index: 1;
      }

    </style>
    <!-- ::POLYMER-BUILD-FIX-CONSOLE:: -->
    <link rel="stylesheet" href="/src/css/console-desktop.css"
      media="(orientation: landscape) and (min-width: 601px), (orientation: portrait) and (min-width: 961px)">
    <!-- ::POLYMER-BUILD-FIX-CONSOLE-END:: -->
    <!-- ::POLYMER-BUILD-FIX-CONSOLE-PROPER::
    <link rel="stylesheet" href="src/css/console-desktop.css"
      media="(orientation: landscape) and (min-width: 601px), (orientation: portrait) and (min-width: 961px)">
    ::POLYMER-BUILD-FIX-CONSOLE-PROPER-END:: -->
    
    <div class="toolbar">
      <img alt="Very cool icon" src="images/icons/192.png">
      <h1 class="header">Specta Player</h1>
    </div>
    
    <div class="toolbar" id="buttons-row">
      <paper-button id="edit-btn" on-tap="_sendCloseEvent">
        <iron-icon icon="console:edit"></iron-icon>
        Edit
      </paper-button>
      <paper-button id="download-btn" on-tap="_downloadConfig">
        <iron-icon icon="console:download"></iron-icon>
        Download
      </paper-button>
      <paper-button id="clear-btn" on-tap="_clearData">
        <iron-icon icon="console:clear"></iron-icon>
        Clear all
      </paper-button>
    </div>
      
    <div class="toolbar" id="actions-row">
      <paper-button id="stop-btn" on-tap="_stopAllTracks">
        <iron-icon icon="console:stop"></iron-icon>
        Stop all
      </paper-button>
      
      <paper-button id="loop-btn" toggles on-active-changed="_toggleLoop">
        <iron-icon icon="console:loop"></iron-icon>
        Loop
      </paper-button>
      
      <paper-button id="crossfade-btn" toggles on-active-changed="_toggleCrossfade">
        <iron-icon icon="console:crossfade"></iron-icon>
        Crossfade
      </paper-button>
      
      <paper-button id="multi-btn" toggles active="{{multi}}" on-active-changed="_multiSwitched">
        <iron-icon icon="console:multi"></iron-icon>
        Multi
      </paper-button>
    </div>
    
    <div id="audio-container"></div>
  </template>

  <script>
    class Console extends Polymer.Element {
      
      static get is() { return 'sp-console'; }
      
      static get properties() { return {
        
        config: Array,
        
        multi: Boolean,
        
        crossfade: Boolean
        
      } }
      
      constructor() {
        super();
      }
      
      connectedCallback() {
        super.connectedCallback();
        
        this._playingTracks = this._playingTracks || [];
        
        this.addEventListener('audioplayed', e => {
          const el = e.detail;
          if (!this.multi) this._stopAllTracks();
          this._playingTracks.push(el);
        });
        
        this.addEventListener('audiopaused', e => {
          const el = e.detail;
          this._playingTracks.splice(this._playingTracks.indexOf(el), 1);
        });
      }
      
      close() {
        this.addEventListener('animationend',
          () => { this.classList.remove('closing'); this.classList.add('hidden'); },
          { once: true });
        this.classList.add('closing');
      }
      
      _sendCloseEvent() {
        window.dispatchEvent(new CustomEvent('open-uploader'));
      }
      
      open() {
        if (this.classList.contains('first-open')) {
          this.classList.remove('first-open');
          this.classList.remove('hidden');

          this._renderElements(this.config);
          this._renderedConfig = JSON.stringify(this.config);
        } else {
          this.addEventListener('animationend', () => this.classList.remove('opening'), { once: true });
          this.classList.add('opening');
          this.classList.remove('hidden');

          const configString = JSON.stringify(this.config);
          if (configString !== this._renderedConfig) {
            this._renderElements(this.config);
            this._renderedConfig = configString;
          }
        }
      }
      
      _renderElements(config) {
        let htmlString = '';
        config.forEach((item, index) => {
          if (item.type === 'label')
            htmlString += `<h2>${item.name}</h2>`;
          else if (item.type === 'audio')
            htmlString += `<sp-player song="${item.song}" index="${index}">${item.name}</sp-player>`;
        });
        this.shadowRoot.querySelector('#audio-container').innerHTML = htmlString;
      }
      
      _stopAllTracks() {
        while(this._playingTracks.length)
          this._playingTracks.forEach(el => {
            el.togglePlay(false);
          });
      }
      
      _multiSwitched(e) {
        const state = e.target.active;
        if (!state && this._playingTracks) {
          const temp = this._playingTracks.pop();
          this._stopAllTracks();
          this._playingTracks.push(temp);
        }
      }
      
      _toggleLoop(e) {
        const state = e.detail.value;
        Array.from(this.shadowRoot.querySelectorAll('sp-player')).forEach(item => {
          item.loop = state;
        });
      }
      
      _toggleCrossfade(e) {
        const state = e.detail.value;
        Array.from(this.shadowRoot.querySelectorAll('sp-player')).forEach(item => {
          item.crossfade = state;
        });
      }
      
      _clearData() {
        Notifier.askDialog('Remove everything?', {
          innerMsg: 'Delete app data and start over?\n(This won\'t remove files from your device)',
          cancelText: 'Keep it',
          acceptText: 'Remove',
          attributes: { id: 'clear-all-dialog' }
        }).then(() => {
          this.dispatchEvent(new CustomEvent('clear-database', { bubbles: true, composed: true }));
        }).catch(e => {
          if (e.error) throw e.error;
        });
      }
      
      _downloadConfig() {
        const data = {
          type: 'SpectaPlayerConfigJSON-rev1',
          order: this.config,
          audio: window.appState.audio
        };
        const file = new File([JSON.stringify(data)], 'specta-player-config.json', { type: "application/json;charset=utf-8" });
        saveAs(file);
      }
      
    }

    customElements.define(Console.is, Console);
  </script>
</dom-module>