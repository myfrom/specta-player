<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="sp-preview-player.html">
<link rel="import" href="shared-styles.html">

<script src="../bower_components/slip/slip.js"></script>

<iron-iconset-svg size="24" name="uploader">
<svg><defs>
<g id="label"><path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"></path></g>
<g id="audio"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"></path></g>
<g id="done"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"></path></g>
<g id="drag-handle"><path d="M20 9H4v2h16V9zM4 15h16v-2H4v2z"></path></g>
<g id="bin"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></g>
<g id="upload"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"></path></g>
<g id="add-audio"><path d=" M 3 5 L 3 2 L 5 2 L 5 5 L 8 5 L 8 7 L 5 7 L 5 10 L 3 10 L 3 7 L 0 7 L 0 5 L 3 5 Z  M 12 3 L 12 12.28 C 11.53 12.11 11.03 12 10.5 12 C 8.01 12 6 14.01 6 16.5 C 6 18.99 8.01 21 10.5 21 C 12.81 21 14.7 19.25 14.95 17 L 15 17 L 15 6 L 19 6 L 19 3 L 12 3 Z "/></g>
<g id="add-label"><path d=" M 17.63 5.84 C 17.27 5.33 16.67 5 16 5 L 9 5 L 9 8 L 6 8 L 6 11 L 3 11 L 3 17 C 3 18.1 3.9 18.99 5 18.99 L 16 19 C 16.67 19 17.27 18.67 17.63 18.16 L 22 12 L 17.63 5.84 Z  M 3 5 L 3 2 L 5 2 L 5 5 L 8 5 L 8 7 L 5 7 L 5 10 L 3 10 L 3 7 L 0 7 L 0 5 L 3 5 Z "/></g>
<g id="upload"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"></path></g>
</defs></svg>
</iron-iconset-svg>

<dom-module id="sp-upload">
  <template>
    <style include="shared-styles">
      
      @keyframes slide-out {
        
        0% {
          opacity: 1;
          transform: none;
        }
        
        70% {
          opacity: 0;
        }
        
        100% {
          opacity: 0;
          transform: translateX(-100%);
        }
        
      }
      
      @keyframes slide-in {
        
        0% {
          opacity: 0;
          transform: translateX(-100%);
        }
        
        70% {
          opacity: 1;
        }
        
        100% {
          opacity: 1;
          transform: none;
        }
        
      }

      @keyframes zoom-out {
        
        0% {
          transform: scale(1);
        }
        
        100% {
          transform: scale(0);
        }
        
      }
      
      @keyframes zoom-in {
        
        0% {
          transform: scale(0);
        }
        
        100% {
          transform: scale(1);
        }
        
      }

      :host(.closing) {
        animation: 360ms ease-in-out slide-out;
      }
      :host(.closing) paper-fab {
        animation: 360ms ease-in zoom-out;
      }

      :host(.opening) {
        animation: 360ms ease-in-out slide-in;
      }
      :host(.opening) paper-fab {
        animation: 360ms ease-out zoom-in;
      }
      
      .toolbar {
        padding-right: 16px;
      }
      .toolbar paper-icon-button {
        color: var(--primary-color);
        width: 46px;
        height: 46px;
      }
      paper-icon-button[icon="uploader:done"] {
        display: none;
      }
      
      #card {
        background-color: var(--white-color);
        border-radius: 2px;
        margin: 8px 0;
        margin-bottom: 88px;
        box-shadow:
          0 3px 4px rgba(0,0,0,0.1),
          0 1px 5px rgba(0,0,0,0.1);
      }
      
      #table-headers > .table-wide, #table-headers > .table-thin {
        opacity: var(--secondary-opacity);
        font-weight: 500;
        font-size: 12px;
      }
      
      .list-item, #table-headers {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: stretch;
        background-color: var(--white-color);
      }
      .list-item > div, #table-headers > div {
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      #table-headers {
        height: 56px;
      }
      .list-item {
        height: 48px;
        border-top: 1px solid var(--divider-color);
      }
      .list-item {
        height: 48px;
      }
      
      .table-left-icons {
        width: 36px;
        padding-left: 14px;
      }
      .table-left-icons > iron-icon {
        opacity: var(--secondary-opacity);
        width: 22px;
        height: 22px;
      }
      .table-left-icons > :first-child {
        display: none;
      }
      
      .table-wide {
        padding: 0 22px;
        flex: 2 0 0;
      }
      .table-wide paper-input {
        --paper-input-container-underline: {
          border-color: var(--divider-color);
        }
      }
      
      .table-thin {
        flex: 1 0 0;
        opacity: var(--primary-opacity);
        font-size: 13px;
      }
      
      .table-right-buttons {
        width: 96px;
        padding-right: 8px;
        padding-left: 8px;
        justify-content: flex-end;
      }
      #table-headers > .table-right-buttons {
        width: 96px;
        padding-right: 8px;
        padding-left: 8px;
      }
      
      :not(#table-headers) > .table-right-buttons paper-icon-button,
      :not(#table-headers) > .table-right-buttons sp-preview-player {
        color: var(--secondary-text-color);
        padding: 10px;
        --preview-player-padding: 10px;
      }
      #table-headers > .table-right-buttons paper-icon-button {
        color: var(--primary-color);
        opacity: 1 !important;
      }
      
      .table-right-buttons [icon="uploader:bin"] {
        display: none;
      }
      
      #slip-container, #slip-container * {
        outline: none;
      }
      
      #slip-container {
        background-color: #e8e8e8;
      }
      
      .slip-reordering {
        opacity: 1;
        position: relative;
        z-index: 1 !important;
        top: 1px;
        border-top: 1px solid var(--white-color);
        border-bottom: 1px solid var(--white-color);
        box-shadow:
          0 8px 10px 1px rgba(0,0,0,0.07),
          0 3px 14px 3px rgba(0,0,0,0.12),
          0 4px 15px 0   rgba(0,0,0,0.07);
      }

      paper-input {
        -webkit-touch-callout: auto;
        -webkit-user-select: auto;
        -moz-user-select: auto;
        -ms-user-select: auto;
        user-select: auto;
      }
      
      paper-fab {
        position: fixed;
        bottom: 16px;
        right: 16px;
        background-color: var(--primary-color) !important;
        box-shadow:
          0 6px 10px rgba(0,0,0,0.14),
          0 1px 18px rgba(0,0,0,0.12),
          0 3px  5px rgba(37,37,37,0.2);
        z-index: 2;
      }
      
    </style>
    <!-- ::POLYMER-BUILD-FIX-UPLOADER:: -->
    <link rel="stylesheet" href="/src/css/uploader-desktop.css"
      media="(orientation: landscape) and (min-width: 601px), (orientation: portrait) and (min-width: 961px)">
    <!-- ::POLYMER-BUILD-FIX-UPLOADER-END:: -->
    <!-- ::POLYMER-BUILD-FIX-UPLOADER-PROPER::
    <link rel="stylesheet" href="src/css/uploader-desktop.css"
      media="(orientation: landscape) and (min-width: 601px), (orientation: portrait) and (min-width: 961px)">
    ::POLYMER-BUILD-FIX-UPLOADER-PROPER-END:: -->
    
    <div class="toolbar">
      <h1 class="header">Upload your audio</h1>
      <paper-icon-button icon="uploader:done" on-tap="_finished"></paper-icon-button>
    </div>
    
    <div id="card">
      <div id="table-headers">
        <div class="table-left-icons"></div>
        <div class="table-wide">Name</div>
        <div class="table-thin">File</div>
        <div class="table-right-buttons">
          <paper-icon-button icon="uploader:add-audio" on-tap="_addAudio"></paper-icon-button>
          <paper-icon-button icon="uploader:add-label" on-tap="_addLabel"></paper-icon-button>
        </div>
      </div>
      <div id="slip-container">
        <template is="dom-repeat" items="{{config}}">
          <div class="list-item" i$="[[index]]">
            <div class="table-left-icons">
              <iron-icon icon="uploader:drag-handle"></iron-icon>
              <iron-icon icon="uploader:[[item.type]]"></iron-icon>
            </div>
            <div class="table-wide">
              <paper-input no-label-float label="Name" value="{{item.name}}"></paper-input>
            </div>
            <div class="table-thin">[[item.song]]</div>
            <div class="table-right-buttons">
            <template is="dom-if" if="[[_isItemAudio(item.type)]]">
              <sp-preview-player song="[[item.song]]"></sp-preview-player>
            </template>
            <paper-icon-button class="action-icon" i$="[[index]]"
              on-tap="_deleteItem" icon="uploader:bin"></paper-icon-button>
            </div>
          </div>
        </template>
      </div>
    </div>
    <paper-fab icon="uploader:done" on-tap="_finished"></paper-fab>
  </template>

  <script>
    class Uploader extends Polymer.Element {
      
      static get is() { return 'sp-upload'; }
      
      static get properties() { return {
        
        config: {
          type: Array,
          notify: true
        }
        
      } }
      
      constructor() {
        super();
        
        this._reactToKeys = e => {
          if (e.path[0].tagName === 'INPUT') return;
          if (e.keyCode === 76) this._addLabel();
          if (e.keyCode === 65) this._addAudio();
        };
        this._reactToResize = e => {
          if (window.matchMedia(window.MOBILE_MEDIA_QUERY).matches) {
            this._isPhone = true;
            if (!this._fab) this._fab = this.shadowRoot.querySelector('paper-fab');
          } else {
            this._isPhone = false;
          }
        };
      }
      
      connectedCallback() {
        super.connectedCallback();
        
        const slipList = this.shadowRoot.querySelector('#slip-container');
        slipList.addEventListener('slip:beforewait', e => {
          if (!this._isPhone) {
            let el = e.target;
            while (el.tagName !== 'DIV') el = el.parentElement;
            if (el.classList.contains('table-left-icons'))
              e.preventDefault();
          }
        });
        slipList.addEventListener('slip:beforeswipe', e => {
          if (e.target.tagName === 'PAPER-INPUT')
            e.preventDefault();
        });
        slipList.addEventListener('slip:swipe', this._deleteItem.bind(this));
        slipList.addEventListener('slip:reorder', e => {
          const moved = this.config.splice(e.detail.originalIndex, 1)[0];
          this.config.splice(e.detail.spliceIndex, 0, moved);
          this.notifySplices('config');
          e.preventDefault();
        });
        new Slip(slipList, { ignoredElements: [ 'dom-repeat' ] });
        
        window.dispatchEvent(new CustomEvent('uploader-loaded'));
      }
      
      close() {
        window.removeEventListener('keydown', this._reactToKeys.bind(this));
        window.removeEventListener('resize', this._reactToResize.bind(this));
        
        this.addEventListener('animationend',
          () => { this.classList.remove('closing'); this.classList.add('hidden'); },
          { once: true });
        this.classList.add('closing');
      }
      
      _finished() {
        window.dispatchEvent(new CustomEvent('open-console'));
        this.notifySplices('config');

        if (sessionStorage.getItem('data-saved')) return;
        if (navigator.storage && navigator.storage.persist) {
          navigator.storage.persist().then(persistend => {
            if (persistend) {
              Notifier.showToast('Saved! Now you can come back to it even offline.');
              gtag('event', 'persistent_storage', {
                'event_category': 'saved_to_persistent'
              });
            } else {
              Notifier.showToast('Saved');
              gtag('event', 'persistent_storage', {
                'event_category': 'saved_to_best_effort'
              });
            }
          });
        } else {
          Notifier.showToast('Saved');
          gtag('event', 'persistent_storage', {
            'event_category': 'saved_with_no_storage_manager'
          });
        }
        sessionStorage.setItem('data-saved', true);
      }
      
      open() {
        window.addEventListener('keydown', this._reactToKeys.bind(this));
        window.addEventListener('resize', this._reactToResize.bind(this));
        
        this._reactToResize();
        
        if (this.classList.contains('first-open')) {
          this.classList.remove('first-open');
          this.classList.remove('hidden');
        } else {
          this.addEventListener('animationend', () => this.classList.remove('opening'), { once: true });
          this.classList.add('opening');
          this.classList.remove('hidden');
        }
      }
      
      async _addAudio() { 
        let stylesheetImport;
        if (!this._loadedDialogStylesheet) {
          stylesheetImport = importCSS('src/css/uploader-audio-dialog.css');
        }
        let audioElements = '';
        Object.keys(window.appState.audio).forEach(key => {
          audioElements += `
            <paper-button dialog-confirm song="${key}" class="uaad-tile">
              <sp-preview-player song="${key}"></sp-preview-player>
              <span>${key}</span>
            </paper-button>
          `;
        });
        const dialogContainer = document.createElement('div');
        dialogContainer.setAttribute('id', 'add-audio-dialog-container');
        document.body.appendChild(dialogContainer);
        if (!this._loadedDialogStylesheet) await stylesheetImport;
        this._loadedDialogStylesheet = true;
        this._pickedSong = null;
        const promise = Notifier.showDialog('Add audio', `
          <div class="uaad-grid">
            <paper-button dialog-confirm autofocus class="uaad-tile">
              <iron-icon class="uaad-big-icon" icon="uploader:upload"></iron-icon>
            </paper-button>
            ${audioElements}
          </div>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
          </div>
        `, {
          attributes: {
            id: 'add-audio-dialog',
            class: 'bottom-sheet'
          },
          formatted: true,
          target: dialogContainer
        });
        const buttons = document.querySelectorAll('.uaad-tile'),
              onAudioChosenHandler = e => this._pickedSong = e.target.getAttribute('song');
        Array.prototype.forEach.call(buttons, (el, index) => {
          if (index === 0)
            el.addEventListener('tap', e => {
              const input = document.createElement('input');
              input.type = 'file';
              input.multiple = true;
              input.accept = 'audio/*';
              input.addEventListener('change', e => {
                const files = e.target.files;
                const shell = document.querySelector('sp-shell');
                const audioTester = new Audio();
                const validFiles = Array.from(files).filter(file => {
                  if (audioTester.canPlayType(file.type)) {
                    console.log('Audio file received');
                    return true;
                  } else if (file.name.match(/\.json$/)) {
                    console.log('JSON object received');
                    return true;
                  } else {
                    console.log('Invalid file received');
                    Notifier.showToast(`You uploaded invalid file 😟`);
                    return false;
                  }
                });
                shell.addEventListener('file-added', e => {
                  if (!this.config.filter(item => (item.song === e.detail.song)).length)
                    this.push('config', e.detail);
                });
                shell.readFiles(validFiles);
                Array.from(document.querySelectorAll('input[type="file"]')).forEach(item => item.remove());
              });
              document.body.appendChild(input);
              input.click();
            }, { once: true });
          else
            el.addEventListener('tap', onAudioChosenHandler);
        });
        promise.then(_ => _, err => {
          if (err.error) {
            gtag('event', 'exception', {
              'description': 'add_label_dialog_error',
              'fatal': false
            });
            throw err;
          };
        }).then(() => {
          if (this._pickedSong) this.push('config', {
            type: "audio",
            name: this._pickedSong.match(/(.+)\..[^\.]+$/)[1],
            song: this._pickedSong
          });
          Array.prototype.forEach.call(buttons, (el, index) => {
            if (index !== 0) el.removeEventListener('tap', onAudioChosenHandler);
          });
          dialogContainer.remove();
        });
      }
      
      _addLabel() {
        const promise = Notifier.showDialog('', `
          <paper-input autofocus no-label-float label="Add label"></paper-input>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm>Add</paper-button>
          </div>
        `, {
          attributes: {
            id: 'add-label-dialog',
            class: 'bottom-sheet'
          },
          formatted: true,
          beforeClose: e => {
            const input = e.target.querySelector('paper-input'),
                  output = input.value;
            input.value = '';
            return output;
          }
        });
        const dialog = document.querySelector('#add-label-dialog'),
              input = dialog.querySelector('paper-input'),
              acceptBtn = dialog.querySelector('[dialog-confirm]');
        input.addEventListener('keydown', function keydownListener(e) {
          if (e.keyCode == 13) {
            acceptBtn.click();
            input.removeEventListener('keydown', keydownListener);
          }
        });
        promise.then(label => {
          if (label && /\S+/.test(String(label))) {
            this.push('config', {
              type: 'label',
              name: label
            });
            gtag('event', 'added_in_uploader', {
              'event_category': 'label'
            });
          };
        }, err => {
          if (err.error) {
            gtag('event', 'exception', {
              'description': 'add_label_dialog_error',
              'fatal': false
            });
            throw err;
          }
        });
      }
      
      _isItemAudio(type) {
        return type === 'audio';
      }
      
      _deleteItem(e) {
        const index = Number(e.target.getAttribute('i')),
              item = this.config.splice(index, 1)[0];
        this.notifySplices('config');
        if (item.type === 'audio') {
          const songName = item.song;
          let usedElsewhere = false;
          setTimeout(() => {
            for (let key in this.config) {
              const entry = this.config[key];
              if (entry.type === 'audio' && entry.song === songName) {
                usedElsewhere = true;
                break;
              }
            };
            if (!usedElsewhere)
              delete window.appState.audio[songName];
          }, 0);
        }
      }
      
    }

    customElements.define(Uploader.is, Uploader);
  </script>
</dom-module>
